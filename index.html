<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOF Monitor Pro v5.0</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        :root {
            --bg-color: #0f0f0f;
            --card-bg: #1e1e1e;
            --accent-color: #00aaff;
            --text-main: #f0f0f0;
            --text-dim: #888;
            --focus-gradient: linear-gradient(90deg, rgba(76,175,80,0) 0%, rgba(76,175,80,0.8) 20%, rgba(76,175,80,0.8) 80%, rgba(76,175,80,0) 100%);
            --warning-color: #ff9800;
            --lock-color: #ff4444;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 500px; }

        .monitor-card {
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: inset 0 0 20px rgba(0,170,255,0.1);
        }

        .monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
            margin-bottom: 8px;
            border-bottom: 1px solid #222;
        }

        .lang-switch {
            background: #333;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 4px;
            font-size: 0.65rem;
            padding: 2px 8px;
            cursor: pointer;
        }

        .status-label { font-size: 0.7rem; font-weight: bold; color: var(--accent-color); }
        .infinity-badge { font-size: 1.2rem; color: var(--warning-color); display: none; }

        .viz-container {
            height: 90px;
            background: repeating-linear-gradient(90deg, #111 0px, #111 49px, #222 50px);
            position: relative;
            border-radius: 4px;
            margin: 10px 0;
        }

        .dof-bar { height: 36px; background: var(--focus-gradient); position: absolute; top: 27px; transition: 0.3s; }
        .subject-marker { width: 2px; height: 60px; background: #fff; position: absolute; top: 15px; z-index: 10; box-shadow: 0 0 10px var(--accent-color); }
        .icon-tree { position: absolute; bottom: 5px; font-size: 18px; filter: grayscale(1); opacity: 0.4; pointer-events: none; }

        .grid-results { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .res-box { background: #151515; padding: 10px; border-radius: 6px; border-top: 1px solid #333; }
        .res-lab { font-size: 0.6rem; color: var(--text-dim); }
        .res-val { font-size: 0.9rem; font-weight: bold; }

        .card { background: var(--card-bg); border-radius: 12px; padding: 18px; margin-bottom: 12px; }
        
        /* „Ç≥„É≥„Éà„É≠„Éº„É´Ë°å„ÅÆ„Çπ„Çø„Ç§„É´‰øÆÊ≠£ */
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 10px;
        }

        .label-group { display: flex; align-items: center; gap: 8px; }

        /* „É≠„ÉÉ„ÇØ„Çπ„Ç§„ÉÉ„ÉÅ */
        .lock-btn {
            background: #333;
            border: 1px solid #555;
            color: #777;
            border-radius: 4px;
            font-size: 0.6rem;
            padding: 4px 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .lock-btn.active {
            background: var(--lock-color);
            border-color: var(--lock-color);
            color: white;
        }

        .input-num-box {
            background: #000;
            border: 1px solid #444;
            color: var(--accent-color);
            font-size: 1.2rem;
            font-weight: bold;
            font-family: monospace;
            text-align: right;
            padding: 4px;
            border-radius: 4px;
            width: 85px;
        }
        .input-num-box.readonly { color: var(--warning-color); border-color: var(--warning-color); }

        input[type="range"] { width: 100%; height: 12px; background: #333; border-radius: 6px; -webkit-appearance: none; margin-bottom: 20px; }
        select { width: 100%; padding: 12px; background: #2a2a2a; color: #fff; border: 1px solid #444; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="monitor-card">
        <div class="monitor-header">
            <button class="lang-switch" onclick="toggleLang()" id="langBtn">EN / JP</button>
            <div style="display:flex; align-items:center; gap:8px;">
                <span id="statusLabel" class="status-label">READY</span>
                <span id="infinityIcon" class="infinity-badge">‚àû</span>
            </div>
        </div>
        <div class="viz-container">
            <span class="icon-tree" style="left: 10px;">üå≤</span>
            <span class="icon-tree" style="left: 50%;">üå≥</span>
            <span class="icon-tree" style="right: 10px;">üèîÔ∏è</span>
            <div id="dofBar" class="dof-bar"></div>
            <div id="subjectMarker" class="subject-marker"></div>
        </div>
        <div class="grid-results">
            <div class="res-box"><div class="res-lab" id="labNear">NEAR</div><div id="nearLimit" class="res-val">-</div></div>
            <div class="res-box"><div class="res-lab" id="labFar">FAR</div><div id="farLimit" class="res-val">-</div></div>
            <div class="res-box"><div class="res-lab" id="labTotal">TOTAL DoF</div><div id="totalDof" class="res-val">-</div></div>
            <div class="res-box"><div class="res-lab" id="labHyper">HYPERFOCAL</div><div id="hyperfocal" class="res-val">-</div></div>
        </div>
    </div>

    <div class="card">
        <label id="labSensor">Sensor / CoC Settings</label>
        <select id="sensorSize" onchange="update('sensor')">
            <option value="1.0">Full Frame (x1.0)</option>
            <option value="1.5">APS-C (x1.5)</option>
            <option value="2.0">Micro Four Thirds (x2.0)</option>
            <option value="5.62">Smartphone 1/1.3"</option>
            <option value="7.61">Action Cam 1/2.3"</option>
        </select>
        <select id="cocBase" onchange="update('sensor')">
            <option value="0.030">0.030mm (Standard)</option>
            <option value="0.020">0.020mm (High Res 45MP+)</option>
            <option value="0.015">0.015mm (Ultra High 100MP+)</option>
        </select>
    </div>

    <div class="card">
        <div class="control-row">
            <div class="label-group">
                <button class="lock-btn" id="lockF" onclick="toggleLock('F')">LOCK</button>
                <label id="labAperture" style="margin:0">Aperture (f)</label>
            </div>
            <input type="number" id="fBox" class="input-num-box" step="0.1" value="8.0" oninput="update('fBox')">
        </div>
        <input type="range" id="fInput" min="0" max="27" step="1" value="18" oninput="update('fRange')">

        <div class="control-row">
            <div class="label-group">
                <button class="lock-btn" id="lockFL" onclick="toggleLock('FL')">LOCK</button>
                <label id="labFocal" style="margin:0">Focal (mm)</label>
            </div>
            <input type="number" id="flBox" class="input-num-box" value="50" oninput="update('flBox')">
        </div>
        <input type="range" id="flInput" min="5" max="600" step="1" value="50" oninput="update('flRange')">

        <div class="control-row">
            <div class="label-group">
                <button class="lock-btn active" id="lockDist" onclick="toggleLock('Dist')">LOCK</button>
                <label id="labDist" style="margin:0">Dist (m)</label>
            </div>
            <input type="number" id="distBox" class="input-num-box" step="0.1" value="3.0" oninput="update('distBox')">
        </div>
        <input type="range" id="distInput" min="0.1" max="50" step="0.1" value="3" oninput="update('distRange')">
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
    }

    const fStops = [1.0, 1.1, 1.2, 1.4, 1.6, 1.8, 2.0, 2.2, 2.5, 2.8, 3.2, 3.5, 4.0, 4.5, 5.0, 5.6, 6.3, 7.1, 8.0, 9.0, 10, 11, 13, 14, 16, 18, 20, 22];
    let currentLang = 'EN';
    let locks = { F: false, FL: false, Dist: true };

    const langData = {
        JP: { ready: "READY", panActive: "PAN-FOCUS", near: "ÂâçÊñπÈôêÁïå", far: "ÂæåÊñπÈôêÁïå", total: "Ë¢´ÂÜôÁïåÊ∑±Â∫¶", hyper: "ÈÅéÁÑ¶ÁÇπË∑ùÈõ¢", sensor: "Ê©üÊùê/Ë®±ÂÆπÈåØ‰π±ÂÜÜ", aperture: "Áµû„ÇäÂÄ§ (f)", focal: "ÁÑ¶ÁÇπË∑ùÈõ¢ (mm)", dist: "Ë∑ùÈõ¢ (m)" },
        EN: { ready: "READY", panActive: "PAN-FOCUS", near: "NEAR", far: "FAR", total: "TOTAL DoF", hyper: "HYPERFOCAL", sensor: "Sensor / CoC", aperture: "Aperture (f)", focal: "Focal (mm)", dist: "Dist (m)" }
    };

    function toggleLang() {
        currentLang = (currentLang === 'EN') ? 'JP' : 'EN';
        const d = langData[currentLang];
        ['labNear','labFar','labTotal','labHyper','labSensor','labAperture','labFocal','labDist'].forEach(id => {
            document.getElementById(id).innerText = d[id.replace('lab','').toLowerCase()];
        });
        update();
    }

    function toggleLock(key) {
        locks[key] = !locks[key];
        document.getElementById('lock' + key).classList.toggle('active', locks[key]);
        document.getElementById(key.toLowerCase() + 'Box').classList.toggle('readonly', locks[key]);
    }

    function update(source) {
        const crop = parseFloat(document.getElementById('sensorSize').value);
        const coc = parseFloat(document.getElementById('cocBase').value) / crop;
        
        let F = parseFloat(document.getElementById('fBox').value);
        let f = parseFloat(document.getElementById('flBox').value);
        let L = parseFloat(document.getElementById('distBox').value) * 1000;

        // „Çπ„É©„Ç§„ÉÄ„Éº/„Éú„ÉÉ„ÇØ„ÇπÂêåÊúü
        if (source === 'fRange') { F = fStops[document.getElementById('fInput').value]; document.getElementById('fBox').value = F.toFixed(1); }
        if (source === 'fBox') document.getElementById('fInput').value = fStops.reduce((p, c, i) => Math.abs(c - F) < Math.abs(fStops[p] - F) ? i : p, 0);
        if (source === 'flRange') { f = document.getElementById('flInput').value; document.getElementById('flBox').value = f; }
        if (source === 'flBox') document.getElementById('flInput').value = f;
        if (source === 'distRange') { L = document.getElementById('distInput').value * 1000; document.getElementById('distBox').value = (L/1000).toFixed(1); }
        if (source === 'distBox') document.getElementById('distInput').value = L/1000;

        // ÈÄÜÁÆó„É≠„Ç∏„ÉÉ„ÇØÔºö„Éë„É≥„Éï„Ç©„Éº„Ç´„Çπ(L=H)„ÇíÂâçÊèê„Å®„Åó„ÅüË®àÁÆó
        // H = f^2 / (F * coc) + f
        // „Åì„Çå„ÇíÂêÑÂ§âÊï∞„Å´„Å§„ÅÑ„Å¶Ëß£„Åè
        if (source === 'distRange' || source === 'distBox') {
             if (!locks.F && locks.FL) { // ÁÑ¶ÁÇπË∑ùÈõ¢Âõ∫ÂÆö„ÄÅÁµû„Çä„ÇíÈÄÜÁÆó
                F = Math.pow(f, 2) / ((L - f) * coc);
                document.getElementById('fBox').value = F.toFixed(1);
                document.getElementById('fInput').value = fStops.reduce((p, c, i) => Math.abs(c - F) < Math.abs(fStops[p] - F) ? i : p, 0);
             } else if (!locks.FL && locks.F) { // Áµû„ÇäÂõ∫ÂÆö„ÄÅÁÑ¶ÁÇπË∑ùÈõ¢„ÇíÈÄÜÁÆó
                f = (coc * F + Math.sqrt(Math.pow(coc * F, 2) + 4 * coc * F * L)) / 2;
                document.getElementById('flBox').value = Math.round(f);
                document.getElementById('flInput').value = Math.round(f);
             }
        }

        const H = (Math.pow(f, 2) / (F * coc)) + f;
        const near = (L * (H - f)) / (H + L - (2 * f));
        let far = (L * (H - f)) / (H - L);
        const isPan = (L >= H || far < 0);
        
        document.getElementById('nearLimit').innerText = (near / 1000).toFixed(2) + "m";
        document.getElementById('farLimit').innerText = isPan ? "‚àû" : (far / 1000).toFixed(2) + "m";
        document.getElementById('totalDof').innerText = isPan ? "PAN-FOCUS" : ((far - near) / 1000).toFixed(2) + "m";
        document.getElementById('hyperfocal').innerText = (H / 1000).toFixed(2) + "m";

        const inf = document.getElementById('infinityIcon'), stat = document.getElementById('statusLabel');
        if (isPan) { inf.style.display = 'inline'; stat.innerText = langData[currentLang].panActive; stat.style.color = "var(--warning-color)"; }
        else { inf.style.display = 'none'; stat.innerText = langData[currentLang].ready; stat.style.color = "var(--accent-color)"; }

        const vizScale = 100 / 50;
        document.getElementById('subjectMarker').style.left = Math.min(98, (L / 1000 * vizScale)) + "%";
        const barL = (near / 1000 * vizScale), barR = isPan ? 100 : (far / 1000 * vizScale);
        document.getElementById('dofBar').style.left = Math.min(99, barL) + "%";
        document.getElementById('dofBar').style.width = Math.max(0, Math.min(100 - barL, (barR - barL))) + "%";
    }

    function calculatePanfocus() {
        // ÁèæÂú®„ÅÆÁµû„Çä„Å®ÁÑ¶ÁÇπË∑ùÈõ¢„Åã„Çâ„ÄÅÈÅéÁÑ¶ÁÇπË∑ùÈõ¢Ôºà„Éë„É≥„Éï„Ç©„Éº„Ç´„ÇπÈñãÂßãÁÇπÔºâ„ÇíÊ±Ç„ÇÅ„Å¶„Éî„É≥„Éà‰ΩçÁΩÆ„Çí‰∏äÊõ∏„Åç
        const crop = parseFloat(document.getElementById('sensorSize').value);
        const coc = parseFloat(document.getElementById('cocBase').value) / crop;
        const F = parseFloat(document.getElementById('fBox').value);
        const f = parseFloat(document.getElementById('flBox').value);
        const H = (Math.pow(f, 2) / (F * coc)) + f;
        document.getElementById('distBox').value = (H / 1000).toFixed(1);
        update('distBox');
    }

    document.getElementById('fInput').max = fStops.length - 1;
    update();
</script>
</body>
</html>
